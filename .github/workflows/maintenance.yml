name: ç¶­è­·æ¨¡å¼ç®¡ç†

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'é¸æ“‡æ“ä½œ'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - end
      reason:
        description: 'ç¶­è­·åŸå› '
        required: false
        default: 'ç³»çµ±å‡ç´š'
        type: string
      duration:
        description: 'é ä¼°ç¶­è­·æ™‚é–“'
        required: false
        default: '1å°æ™‚'
        type: string
      contact:
        description: 'è¯çµ¡æ–¹å¼'
        required: false
        default: 'makerbackup0821@gmail.com'
        type: string

jobs:
  maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: æª¢æŸ¥å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è¨­å®š Git ä½¿ç”¨è€…
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: å•Ÿå‹•ç¶­è­·æ¨¡å¼
        if: ${{ inputs.action == 'start' }}
        run: |
          echo "ğŸ”§ å•Ÿå‹•ç¶­è­·æ¨¡å¼..."
          
          # å»ºç«‹ç¶­è­·ç‹€æ…‹æª”æ¡ˆ
          cat > maintenance-status.json << EOF
          {
              "maintenance": true,
              "message": "ç³»çµ±ç¶­è­·ä¸­ - ${{ inputs.reason }}",
              "startTime": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
              "endTime": null,
              "reason": "${{ inputs.reason }}",
              "duration": "${{ inputs.duration }}",
              "contact": "${{ inputs.contact }}",
              "triggeredBy": "GitHub Action",
              "triggeredAt": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          }
          EOF
          
          # å‚™ä»½åŸå§‹ index.html
          if [ ! -f "index.html.backup" ]; then
            cp index.html index.html.backup
            echo "âœ… å·²å‚™ä»½åŸå§‹ index.html"
          fi
          
          # å»ºç«‹é‡å°å‘åˆ°ç¶­è­·é é¢çš„ index.html
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ç³»çµ±ç¶­è­·ä¸­ - ç„¡éšœç¤™å»æ‰€GO V2</title>
              <meta http-equiv="refresh" content="0; url=maintenance.html">
              <style>
                  body {
                      font-family: 'Noto Sans TC', sans-serif;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container {
                      text-align: center;
                      padding: 2rem;
                  }
                  .spinner {
                      border: 4px solid rgba(255,255,255,0.3);
                      border-radius: 50%;
                      border-top: 4px solid white;
                      width: 40px;
                      height: 40px;
                      animation: spin 1s linear infinite;
                      margin: 0 auto 1rem;
                  }
                  @keyframes spin {
                      0% { transform: rotate(0deg); }
                      100% { transform: rotate(360deg); }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="spinner"></div>
                  <h1>ç³»çµ±ç¶­è­·ä¸­</h1>
                  <p>æ­£åœ¨é‡å°å‘åˆ°ç¶­è­·é é¢...</p>
              </div>
              <script>
                  window.location.href = 'maintenance.html';
              </script>
          </body>
          </html>
          EOF
          
          echo "âœ… ç¶­è­·æ¨¡å¼å·²å•Ÿå‹•"
          echo "ğŸ“Š ç¶­è­·è³‡è¨Šï¼š"
          echo "  - åŸå› : ${{ inputs.reason }}"
          echo "  - æ™‚é–“: ${{ inputs.duration }}"
          echo "  - è¯çµ¡: ${{ inputs.contact }}"

      - name: çµæŸç¶­è­·æ¨¡å¼
        if: ${{ inputs.action == 'end' }}
        run: |
          echo "ğŸ”§ çµæŸç¶­è­·æ¨¡å¼..."
          
          # æ›´æ–°ç¶­è­·ç‹€æ…‹æª”æ¡ˆ
          cat > maintenance-status.json << EOF
          {
              "maintenance": false,
              "message": "ç³»çµ±æ­£å¸¸é‹è¡Œ",
              "startTime": null,
              "endTime": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
              "reason": null,
              "duration": null,
              "contact": null,
              "endedBy": "GitHub Action",
              "endedAt": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          }
          EOF
          
          # æ¢å¾©åŸå§‹ index.html
          if [ -f "index.html.backup" ]; then
            cp index.html.backup index.html
            echo "âœ… å·²æ¢å¾©åŸå§‹ index.html"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ°å‚™ä»½æª”æ¡ˆï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ index.html"
          fi
          
          echo "âœ… ç¶­è­·æ¨¡å¼å·²çµæŸ"
          echo "ğŸŒ ç¶²ç«™ç¾åœ¨æ­£å¸¸é‹è¡Œ"

      - name: æäº¤è®Šæ›´
        run: |
          git add maintenance-status.json index.html
          
          if [ "${{ inputs.action }}" == "start" ]; then
            git commit -m "ğŸ”§ å•Ÿå‹•ç¶­è­·æ¨¡å¼

          - åŸå› : ${{ inputs.reason }}
          - æ™‚é–“: ${{ inputs.duration }}
          - è¯çµ¡: ${{ inputs.contact }}
          - è§¸ç™¼: GitHub Action"
          else
            git commit -m "âœ… çµæŸç¶­è­·æ¨¡å¼

          - ç³»çµ±å·²æ¢å¾©æ­£å¸¸é‹è¡Œ
          - è§¸ç™¼: GitHub Action"
          fi
          
          git push

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./

      - name: å»ºç«‹ç¶­è­·è¨˜éŒ„
        if: ${{ inputs.action == 'start' }}
        run: |
          echo "ğŸ“ å»ºç«‹ç¶­è­·è¨˜éŒ„..."
          
          # å»ºç«‹ç¶­è­·è¨˜éŒ„ç›®éŒ„
          mkdir -p .maintenance-logs
          
          # å»ºç«‹ç¶­è­·è¨˜éŒ„æª”æ¡ˆ
          cat > .maintenance-logs/maintenance-$(date +%Y%m%d-%H%M%S).log << EOF
          === ç¶­è­·è¨˜éŒ„ ===
          é–‹å§‹æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ç¶­è­·åŸå› : ${{ inputs.reason }}
          é ä¼°æ™‚é–“: ${{ inputs.duration }}
          è¯çµ¡æ–¹å¼: ${{ inputs.contact }}
          è§¸ç™¼æ–¹å¼: GitHub Action
          æ“ä½œè€…: ${{ github.actor }}
          æäº¤: ${{ github.sha }}
          ================
          EOF
          
          echo "âœ… ç¶­è­·è¨˜éŒ„å·²å»ºç«‹"

      - name: ç™¼é€é€šçŸ¥
        if: always()
        run: |
          if [ "${{ inputs.action }}" == "start" ]; then
            echo "ğŸ”” ç¶­è­·æ¨¡å¼å·²å•Ÿå‹•"
            echo "ğŸ“§ å¦‚éœ€é€šçŸ¥åœ˜éšŠæˆå“¡ï¼Œè«‹æ‰‹å‹•ç™¼é€é€šçŸ¥"
          else
            echo "ğŸ”” ç¶­è­·æ¨¡å¼å·²çµæŸ"
            echo "ğŸ“§ ç³»çµ±å·²æ¢å¾©æ­£å¸¸é‹è¡Œ"
          fi

      - name: é¡¯ç¤ºçµæœ
        if: always()
        run: |
          echo "=== æ“ä½œå®Œæˆ ==="
          echo "æ“ä½œ: ${{ inputs.action }}"
          echo "æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç‹€æ…‹: ${{ job.status }}"
          echo "================"
          
          if [ -f "maintenance-status.json" ]; then
            echo "ğŸ“„ ç•¶å‰ç¶­è­·ç‹€æ…‹ï¼š"
            cat maintenance-status.json
          fi
