name: ç¶­è­·æ¨¡å¼ç®¡ç†

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'é¸æ“‡æ“ä½œ'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - end
      reason:
        description: 'ç¶­è­·åŽŸå› '
        required: false
        default: 'ç³»çµ±å‡ç´š'
        type: string
      duration:
        description: 'é ä¼°ç¶­è­·æ™‚é–“'
        required: false
        default: '1å°æ™‚'
        type: string
      contact:
        description: 'è¯çµ¡æ–¹å¼'
        required: false
        default: 'makerbackup0821@gmail.com'
        type: string

jobs:
  maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: æª¢æŸ¥å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è¨­å®š Git ä½¿ç”¨è€…
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: å•Ÿå‹•ç¶­è­·æ¨¡å¼
        if: ${{ inputs.action == 'start' }}
        run: |
          echo "ðŸ”§ å•Ÿå‹•ç¶­è­·æ¨¡å¼..."
          
          # å»ºç«‹ç¶­è­·ç‹€æ…‹æª”æ¡ˆ
          cat > maintenance-status.json << EOF
          {
              "maintenance": true,
              "message": "ç³»çµ±ç¶­è­·ä¸­ - ${{ inputs.reason }}",
              "startTime": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
              "endTime": null,
              "reason": "${{ inputs.reason }}",
              "duration": "${{ inputs.duration }}",
              "contact": "${{ inputs.contact }}",
              "triggeredBy": "GitHub Action",
              "triggeredAt": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          }
          EOF
          
          # å‚™ä»½åŽŸå§‹ index.html ç‚º main_index.html
          if [ ! -f "main_index.html" ]; then
            cp index.html main_index.html
            echo "âœ… å·²å‚™ä»½åŽŸå§‹ index.html ç‚º main_index.html"
          fi
          
          # å°‡ maintenance.html è¤‡è£½ç‚º index.html
          if [ -f "maintenance.html" ]; then
            cp maintenance.html index.html
            echo "âœ… å·²å°‡ç¶­è­·é é¢è¨­ç‚ºé¦–é "
          else
            echo "âŒ æ‰¾ä¸åˆ° maintenance.html æª”æ¡ˆ"
            exit 1
          fi
          
          echo "âœ… ç¶­è­·æ¨¡å¼å·²å•Ÿå‹•"
          echo "ðŸ“Š ç¶­è­·è³‡è¨Šï¼š"
          echo "  - åŽŸå› : ${{ inputs.reason }}"
          echo "  - æ™‚é–“: ${{ inputs.duration }}"
          echo "  - è¯çµ¡: ${{ inputs.contact }}"

      - name: çµæŸç¶­è­·æ¨¡å¼
        if: ${{ inputs.action == 'end' }}
        run: |
          echo "ðŸ”§ çµæŸç¶­è­·æ¨¡å¼..."
          
          # æ›´æ–°ç¶­è­·ç‹€æ…‹æª”æ¡ˆ
          cat > maintenance-status.json << EOF
          {
              "maintenance": false,
              "message": "ç³»çµ±æ­£å¸¸é‹è¡Œ",
              "startTime": null,
              "endTime": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
              "reason": null,
              "duration": null,
              "contact": null,
              "endedBy": "GitHub Action",
              "endedAt": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          }
          EOF
          
          # æ¢å¾©åŽŸå§‹ index.html
          if [ -f "main_index.html" ]; then
            cp main_index.html index.html
            echo "âœ… å·²æ¢å¾©åŽŸå§‹ index.html"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ°å‚™ä»½æª”æ¡ˆ main_index.htmlï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ index.html"
          fi
          
          echo "âœ… ç¶­è­·æ¨¡å¼å·²çµæŸ"
          echo "ðŸŒ ç¶²ç«™ç¾åœ¨æ­£å¸¸é‹è¡Œ"

      - name: æäº¤è®Šæ›´
        run: |
          git add maintenance-status.json index.html
          
          if [ "${{ inputs.action }}" == "start" ]; then
            git commit -m "ðŸ”§ å•Ÿå‹•ç¶­è­·æ¨¡å¼

          - åŽŸå› : ${{ inputs.reason }}
          - æ™‚é–“: ${{ inputs.duration }}
          - è¯çµ¡: ${{ inputs.contact }}
          - è§¸ç™¼: GitHub Action"
          else
            git commit -m "âœ… çµæŸç¶­è­·æ¨¡å¼

          - ç³»çµ±å·²æ¢å¾©æ­£å¸¸é‹è¡Œ
          - è§¸ç™¼: GitHub Action"
          fi
          
          git push

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./

      - name: å»ºç«‹ç¶­è­·è¨˜éŒ„
        if: ${{ inputs.action == 'start' }}
        run: |
          echo "ðŸ“ å»ºç«‹ç¶­è­·è¨˜éŒ„..."
          
          # å»ºç«‹ç¶­è­·è¨˜éŒ„ç›®éŒ„
          mkdir -p .maintenance-logs
          
          # å»ºç«‹ç¶­è­·è¨˜éŒ„æª”æ¡ˆ
          cat > .maintenance-logs/maintenance-$(date +%Y%m%d-%H%M%S).log << EOF
          === ç¶­è­·è¨˜éŒ„ ===
          é–‹å§‹æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ç¶­è­·åŽŸå› : ${{ inputs.reason }}
          é ä¼°æ™‚é–“: ${{ inputs.duration }}
          è¯çµ¡æ–¹å¼: ${{ inputs.contact }}
          è§¸ç™¼æ–¹å¼: GitHub Action
          æ“ä½œè€…: ${{ github.actor }}
          æäº¤: ${{ github.sha }}
          ================
          EOF
          
          echo "âœ… ç¶­è­·è¨˜éŒ„å·²å»ºç«‹"

      - name: ç™¼é€é€šçŸ¥
        if: always()
        run: |
          if [ "${{ inputs.action }}" == "start" ]; then
            echo "ðŸ”” ç¶­è­·æ¨¡å¼å·²å•Ÿå‹•"
            echo "ðŸ“§ å¦‚éœ€é€šçŸ¥åœ˜éšŠæˆå“¡ï¼Œè«‹æ‰‹å‹•ç™¼é€é€šçŸ¥"
          else
            echo "ðŸ”” ç¶­è­·æ¨¡å¼å·²çµæŸ"
            echo "ðŸ“§ ç³»çµ±å·²æ¢å¾©æ­£å¸¸é‹è¡Œ"
          fi

      - name: é¡¯ç¤ºçµæžœ
        if: always()
        run: |
          echo "=== æ“ä½œå®Œæˆ ==="
          echo "æ“ä½œ: ${{ inputs.action }}"
          echo "æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç‹€æ…‹: ${{ job.status }}"
          echo "================"
          
          if [ -f "maintenance-status.json" ]; then
            echo "ðŸ“„ ç•¶å‰ç¶­è­·ç‹€æ…‹ï¼š"
            cat maintenance-status.json
          fi
