name: ç¶­è­·æ¨¡å¼ç®¡ç† (ç°¡åŒ–ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'é¸æ“‡æ“ä½œ'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - end
      reason:
        description: 'ç¶­è­·åŸå› '
        required: false
        default: 'ç³»çµ±å‡ç´š'
        type: string

jobs:
  maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æª¢æŸ¥å„²å­˜åº«
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¨­å®š Git ä½¿ç”¨è€…
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: å•Ÿå‹•ç¶­è­·æ¨¡å¼
        if: ${{ inputs.action == 'start' }}
        run: |
          echo "ğŸ”§ å•Ÿå‹•ç¶­è­·æ¨¡å¼..."
          
          # å»ºç«‹ç¶­è­·ç‹€æ…‹æª”æ¡ˆ
          cat > maintenance-status.json << EOF
          {
              "maintenance": true,
              "message": "ç³»çµ±ç¶­è­·ä¸­ - ${{ inputs.reason }}",
              "startTime": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
              "endTime": null,
              "reason": "${{ inputs.reason }}",
              "triggeredBy": "GitHub Action"
          }
          EOF
          
          # å‚™ä»½åŸå§‹ index.html ç‚º main_index.html
          if [ ! -f "main_index.html" ]; then
            cp index.html main_index.html
          fi
          
          # å°‡ maintenance.html è¤‡è£½ç‚º index.html
          if [ -f "maintenance.html" ]; then
            cp maintenance.html index.html
          else
            echo "âŒ æ‰¾ä¸åˆ° maintenance.html æª”æ¡ˆ"
            exit 1
          fi
          
          echo "âœ… ç¶­è­·æ¨¡å¼å·²å•Ÿå‹•"

      - name: çµæŸç¶­è­·æ¨¡å¼
        if: ${{ inputs.action == 'end' }}
        run: |
          echo "ğŸ”§ çµæŸç¶­è­·æ¨¡å¼..."
          
          # æ›´æ–°ç¶­è­·ç‹€æ…‹æª”æ¡ˆ
          cat > maintenance-status.json << EOF
          {
              "maintenance": false,
              "message": "ç³»çµ±æ­£å¸¸é‹è¡Œ",
              "startTime": null,
              "endTime": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
              "reason": null,
              "endedBy": "GitHub Action"
          }
          EOF
          
          # æ¢å¾©åŸå§‹ index.html
          if [ -f "main_index.html" ]; then
            cp main_index.html index.html
          fi
          
          echo "âœ… ç¶­è­·æ¨¡å¼å·²çµæŸ"

      - name: æäº¤è®Šæ›´
        run: |
          git add maintenance-status.json index.html
          
          if [ "${{ inputs.action }}" == "start" ]; then
            git commit -m "ğŸ”§ å•Ÿå‹•ç¶­è­·æ¨¡å¼ - ${{ inputs.reason }}"
          else
            git commit -m "âœ… çµæŸç¶­è­·æ¨¡å¼"
          fi
          
          git push
